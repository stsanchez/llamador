<!DOCTYPE html>
<html>
<head>
    <title>Vista de Pacientes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f4f8;
        }

        h1 {
            text-align: center;
            margin-top: 20px;
            color: #007bff;
        }

        #pacientes-lista {
            list-style-type: none;
            padding: 0;
            width: 350px; /* Aumenta el ancho si es necesario */
            margin: 0 auto;
        }

        #pacientes-lista li {
            background-color: #fff;
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            overflow: hidden; /* Oculta el desbordamiento si hay demasiado contenido */
            position: relative; /* Para usar el posicionamiento relativo */
        }

        #pacientes-lista .info {
            flex: 1; /* Ocupa el espacio restante */
            margin-right: 10px; /* Espacio entre la información y los botones */
            white-space: nowrap; /* Evita que el texto se ajuste a varias líneas */
            overflow: hidden; /* Oculta el desbordamiento */
            text-overflow: ellipsis; /* Muestra '...' si el texto es demasiado largo */
        }

        #pacientes-lista .btn-container {
            display: flex;
            gap: 5px; /* Espacio entre los botones */
        }

        #pacientes-lista .btn {
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            color: #fff;
            font-size: 14px;
            white-space: nowrap; /* Evita que el texto se ajuste a varias líneas */
        }

        #pacientes-lista .btn-llamar {
            background-color: #007bff; /* Azul para llamadas */
        }

        #pacientes-lista .btn-llamar:hover {
            background-color: #0056b3; /* Azul oscuro para hover */
        }

        #pacientes-lista .btn-atendido {
            background-color: #28a745; /* Verde para atendido */
        }

        #pacientes-lista .btn-atendido:hover {
            background-color: #1e7e34; /* Verde oscuro para hover */
        }

        #pacientes-lista .btn-error {
            background-color: #dc3545; /* Rojo para errores */
        }

        #pacientes-lista .btn-error:hover {
            background-color: #c82333; /* Rojo oscuro para hover */
        }

        #notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #28a745;
            color: white;
            padding: 15px;
            border-radius: 4px;
            display: none;
            z-index: 9999;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .fade-out {
            opacity: 0;
            transition: opacity 1s ease-out;
        }
    </style>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <h1>Pacientes</h1>
    <ul id="pacientes-lista"></ul>
    <div id="notification"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();
            const notificationElement = document.getElementById('notification');

            // Manejar la notificación de llamada
            socket.on('llamada', (data) => {
                notificationElement.textContent = `Llamando a ${data.nombre} ${data.apellido}`;
                notificationElement.style.display = 'block';
                setTimeout(() => {
                    notificationElement.style.display = 'none';
                }, 5000); // Mostrar por 5 segundos
            });

            // Función para llamar a un paciente
            window.llamarPaciente = (id) => {
                fetch(`/llamar/${id}`);
            };

            // Función para marcar a un paciente como atendido
            window.marcarAtendido = (id) => {
                fetch(`/atendido/${id}`, {
                    method: 'PATCH',
                }).then(() => {
                    // Actualizar la lista de pacientes después de marcarlo como atendido
                    const item = document.querySelector(`[data-id="${id}"]`);
                    if (item) {
                        // Mostrar mensaje y aplicar el efecto de desvanecimiento
                        notificationElement.textContent = 'Paciente atendido y eliminado de la lista de espera';
                        notificationElement.style.display = 'block';
                        item.classList.add('fade-out');
                        setTimeout(() => {
                            item.remove();
                            notificationElement.style.display = 'none';
                        }, 1000); // Tiempo igual al de la animación
                    }
                });
            };

            // Cargar lista de pacientes
            fetch('/pacientes')
                .then(response => response.json())
                .then(pacientes => {
                    const lista = document.getElementById('pacientes-lista');
                    pacientes.forEach(paciente => {
                        const item = document.createElement('li');
                        item.setAttribute('data-id', paciente.id);

                        // Extraer solo la hora del campo 'horario'
                        const horario = new Date(paciente.horario).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                        // Crear un contenedor para la información del paciente
                        const info = document.createElement('div');
                        info.textContent = `${paciente.nombre} ${paciente.apellido} - ${horario}`;
                        info.className = 'info'; // Añadir clase para la información

                        // Crear un contenedor para los botones
                        const btnContainer = document.createElement('div');
                        btnContainer.className = 'btn-container';

                        const botonLlamar = document.createElement('button');
                        botonLlamar.textContent = 'Llamar';
                        botonLlamar.className = 'btn btn-llamar';
                        botonLlamar.onclick = () => window.llamarPaciente(paciente.id);

                        const botonAtendido = document.createElement('button');
                        botonAtendido.textContent = 'Atendido';
                        botonAtendido.className = 'btn btn-atendido';
                        botonAtendido.onclick = () => window.marcarAtendido(paciente.id);

                        // Añadir botones al contenedor
                        btnContainer.appendChild(botonLlamar);
                        btnContainer.appendChild(botonAtendido);

                        // Añadir elementos al item
                        item.appendChild(info);
                        item.appendChild(btnContainer);

                        lista.appendChild(item);
                    });
                });
        });
    </script>
</body>
</html>
